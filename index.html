<!DOCTYPE html>
<html>
<head>
    <title>Button Box Recovery</title>
    <script src="avrgirl-arduino.browser.min.js"></script>
</head>
<body style="font-family: sans-serif; text-align: center; padding: 50px;">
    <h1>Button Box Recovery</h1>
    <p>Connect your box via USB, then click the button below.</p>
    
    <button id="flash" style="background: #008060; color: white; padding: 20px; border-radius: 10px; font-size: 20px; cursor: pointer; border: none;">
        REPAIR MY BUTTON BOX
    </button>

    <p id="status" style="margin-top: 20px; font-weight: bold; color: #555;">Status: Ready</p>

    <script>
        document.getElementById('flash').addEventListener('click', function() {
            var status = document.getElementById('status');
            
            // Checking both possible names for the library
            var Avrgirl = window.AvrgirlArduino || window.avrgirlArduino;

            if (!Avrgirl) {
                status.innerText = "Error: Library still not loading. Try a different browser.";
                return;
            }

            var avrgirl = new Avrgirl({ board: 'leonardo' });
            status.innerText = "Connecting... select your device in the popup.";

            // Pointing to the .hex file you uploaded to GitHub
            var hexUrl = 'TruckSimV1.hex';

            fetch(hexUrl)
                .then(response => {
                    if (!response.ok) throw new Error('Could not find the firmware file on the server.');
                    return response.arrayBuffer();
                })
                .then(buffer => {
                    status.innerText = "File loaded. Searching for device...";
                    
                    avrgirl.flash(buffer, function(err) {
                        if (err) {
                            status.innerText = "Error: " + err.message;
                        } else {
                            status.innerText = "SUCCESS! Your box has been updated.";
                        }
                    });
                })
                .catch(err => {
                    status.innerText = "Error: " + err.message;
                });
        });
    </script>
</body>
</html>
