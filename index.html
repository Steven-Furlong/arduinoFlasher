<script>
    document.getElementById('flash').addEventListener('click', function() {
        var status = document.getElementById('status');
        
        // Change the "A" to lowercase "a" and "G" to lowercase "g" 
        // to match exactly how the library is written: avrgirlArduino
        if (typeof avrgirlArduino === 'undefined') {
            status.innerText = "Error: Flashing library failed to load.";
            return;
        }

        var avrgirl = new avrgirlArduino({ board: 'leonardo' });
        status.innerText = "Connecting... Please wait.";

        var hexUrl = 'https://cdn.shopify.com/s/files/1/0793/6956/8485/files/TruckSimV1.hex?v=1770316477';

        fetch(hexUrl, { mode: 'cors' })
            .then(response => {
                if (!response.ok) throw new Error('Could not download firmware file.');
                return response.arrayBuffer();
            })
            .then(buffer => {
                status.innerText = "Device found! Flashing now... do not unplug.";
                
                avrgirl.flash(buffer, function(err) {
                    if (err) {
                        status.innerText = "Error: " + err.message;
                    } else {
                        status.innerText = "DONE! Your TruckSim Box is ready.";
                    }
                });
            })
            .catch(err => {
                status.innerText = "Error: " + err.message;
            });
    });
</script>
